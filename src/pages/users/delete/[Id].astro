---
import Layout from "../../../layouts/Layout.astro";
import UsuarisController from "../../../classes/UsuarisController";
import ReceptesController from "../../../classes/ReceptesController";
const { Id } = Astro.params;
const lang = Astro.cookies.get('idiom');


const usuarisController = new UsuarisController();
const recetasController = new ReceptesController();


const { nom: nombre } = await usuarisController.getUsuariById(Id);



if (Astro.request.method === "POST") {
  const usuarisController = new UsuarisController();
  const data = await Astro.request.formData();
  const id = data.get("dlt");
  
  const {list: listReceptas} = await recetasController.getAllReceptes();
  const listIdReceptas = listReceptas.filter(r => r.usuari == nombre).map(r => r.Id)
  //hay que confirmar que se recibe una lista de identificadores de recetas
  //hay que debugar pero la logica es esta
  listIdReceptas.forEach(async id => await recetasController.deleteRecepta(id))
  
  
  await usuarisController.deleteUsuari(id);

  return Astro.redirect("/login");
}
---

<Layout title={lang?.value === 'ca' ? 'Eliminar usuari' : 'Eliminar usuario'}>
  <div class="w-3/4 mx-auto flex flex-col mt-7 " >
    <h1 class="relative flex justify-center items-center h-20 w-2/3 self-center bg-red-600/40 text-white/90 text-lg font-semibold rounded-xl border-red-900 border-4 border-double " >
      <img src="/alert.svg" class="absolute left-8">
      {
        lang.value === "ca"
          ? "Segur que vols eliminar a "
          : "Seguro que quieres eliminar a "
      }
      {nombre}?
    </h1>
  
    <form class="w-1/2 flex justify-center mx-auto mt-7" method="post">
      <input name="dlt" type="hidden" value={Id} />
      <button class="w-1/4  bg-gray-500/70 my-4 mx-6 rounded-md border-black/30 border-2  " type="button" ><a class="size-full flex items-center justify-center p-4 " href="/">No</a></button>
      <button  class="w-1/4 py-3 px-6 bg-red-700/80 my-4 mx-6 rounded-md border-black/30 border-2  " type="submit">SÃ­</button>
    </form>
  </div>
</Layout>
